<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comfy Table WASM - Comprehensive Test Suite</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007acc;
            padding-bottom: 10px;
        }
        
        .test-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .test-summary h2 {
            margin: 0 0 10px 0;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 5px;
        }
        
        .test-result {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .test-header {
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .test-header.pass {
            background-color: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .test-header.fail {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        .test-header.running {
            background-color: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
        
        .test-content {
            padding: 20px;
        }
        
        .test-output {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-metadata {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .error-message {
            background-color: #ffe6e6;
            border: 1px solid #ff9999;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            color: #cc0000;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .collapsible {
            cursor: pointer;
            user-select: none;
        }
        
        .collapsible:after {
            content: ' ‚ñº';
            font-size: 12px;
        }
        
        .collapsible.collapsed:after {
            content: ' ‚ñ∂';
        }
        
        .collapsible-content {
            display: block;
        }
        
        .collapsible-content.collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üöÄ Comfy Table WASM - Comprehensive Test Suite</h1>
    
    <div class="test-summary" id="summary">
        <h2>Test Summary</h2>
        <div class="summary-stats">
            <div class="stat">
                <div>Total Tests</div>
                <div id="total-tests">-</div>
            </div>
            <div class="stat">
                <div>Passed</div>
                <div id="passed-tests">-</div>
            </div>
            <div class="stat">
                <div>Failed</div>
                <div id="failed-tests">-</div>
            </div>
            <div class="stat">
                <div>Success Rate</div>
                <div id="success-rate">-</div>
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
    </div>
    
    <div class="controls">
        <button id="run-tests" onclick="runAllTests()">üöÄ Run Synchronized Tests</button>
        <button id="run-original-tests" onclick="runOriginalTests()">üìã Run Original Tests</button>
        <button id="clear-results" onclick="clearResults()">üßπ Clear Results</button>
        <button id="toggle-all" onclick="toggleAllOutputs()">üëÅÔ∏è Toggle All Outputs</button>
        <button id="debug-mode" onclick="toggleDebugMode()">üîç Debug Mode: OFF</button>
    </div>
    
    <div id="test-results">
        <div class="loading">
            <h2>üöÄ Synchronized Tests</h2>
            <p>Tests synchronized with the original comfy-table library, covering table creation, styling presets, dynamic content arrangement, and performance benchmarks.</p>
            <p>üé® <strong>Enhanced with ANSI colors</strong> - All table outputs are beautifully colorized and rendered as HTML!</p>
            <p>‚úÖ <strong>Exact reproduction</strong> of original test behaviors within WASM API constraints.</p>
            
            <h2>üìã Original Tests</h2>
            <p>The original test suite with additional ANSI conversion tests and edge cases.</p>
            <p>üîß <strong>Broader coverage</strong> including custom scenarios and comprehensive functionality testing.</p>
            
            <hr style="margin: 20px 0;">
            <p><strong>Choose a test suite above to begin testing!</strong></p>
        </div>
    </div>
    
    <script type="module">
        import init, { TableWrapper, create_large_table, create_aaaaaaaa_table, convert_ansi_to_html, convert_ansi_to_html_with_options } from '../pkg-web/comfy_table_wasm.js';
        import { createSynchronizedTestSuite } from './test-suite-synchronized.js';
        import { createTestSuite } from './test-suite.js';
        
        let wasmInitialized = false;
        let synchronizedTestSuite = null;
        let originalTestSuite = null;
        let currentResults = [];
        let debugMode = false;
        
        async function initializeWasm() {
            if (!wasmInitialized) {
                await init();
                synchronizedTestSuite = createSynchronizedTestSuite(TableWrapper, create_large_table, create_aaaaaaaa_table, convert_ansi_to_html, convert_ansi_to_html_with_options);
                originalTestSuite = createTestSuite(TableWrapper, create_large_table, create_aaaaaaaa_table, convert_ansi_to_html, convert_ansi_to_html_with_options);
                wasmInitialized = true;
            }
        }
        
        async function runTestSuite(testSuite, suiteName) {
            const runButton = document.getElementById('run-tests');
            const originalButton = document.getElementById('run-original-tests');
            const resultsDiv = document.getElementById('test-results');
            
            try {
                runButton.disabled = true;
                originalButton.disabled = true;
                runButton.textContent = 'Initializing WASM...';
                
                await initializeWasm();
                
                runButton.textContent = `Running ${suiteName}...`;
                resultsDiv.innerHTML = `<div class="loading">Running ${suiteName}...</div>`;
                
                // Get all tests
                const tests = testSuite.tests;
                const totalTests = tests.length;
                
                // Update summary
                updateSummary(totalTests, 0, 0, 0);
                
                // Create test result containers
                resultsDiv.innerHTML = '';
                tests.forEach((test, index) => {
                    const testDiv = createTestResultDiv(test.name, index);
                    resultsDiv.appendChild(testDiv);
                });
                
                // Run tests one by one with updates
                currentResults = [];
                let passed = 0;
                let failed = 0;
                
                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    const testDiv = document.getElementById(`test-${i}`);
                    const headerDiv = testDiv.querySelector('.test-header');
                    const contentDiv = testDiv.querySelector('.test-content');
                    
                    // Mark as running
                    headerDiv.className = 'test-header running';
                    headerDiv.querySelector('.status').textContent = 'RUNNING';
                    
                    try {
                        const startTime = performance.now();
                        const result = await test.testFn();
                        const endTime = performance.now();
                        const duration = endTime - startTime;
                        
                        // Success
                        headerDiv.className = 'test-header pass';
                        headerDiv.querySelector('.status').textContent = 'PASS';
                        headerDiv.querySelector('.duration').textContent = `${duration.toFixed(2)}ms`;
                        
                        // Add result content
                        contentDiv.innerHTML = formatTestResult(result, duration);
                        
                        passed++;
                        currentResults.push({
                            name: test.name,
                            status: 'PASS',
                            result: result,
                            duration: duration,
                            error: null
                        });
                        
                    } catch (error) {
                        // Failure
                        headerDiv.className = 'test-header fail';
                        headerDiv.querySelector('.status').textContent = 'FAIL';
                        
                        // Try to get debug information by running a simplified version
                        let debugContent = `
                            <div class="error-message">
                                <strong>‚ùå Test Failed:</strong> ${error.message}
                            </div>
                        `;
                        
                        // Add debug button for failed tests
                        debugContent += `
                            <div class="test-metadata">
                                <button onclick="debugFailedTest('${test.name}')" style="margin: 10px 0; padding: 5px 10px; background: #ff6b6b; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                    üîç Debug This Test
                                </button>
                            </div>
                        `;
                        
                        contentDiv.innerHTML = debugContent;
                        
                        failed++;
                        currentResults.push({
                            name: test.name,
                            status: 'FAIL',
                            result: null,
                            duration: 0,
                            error: error.message
                        });
                    }
                    
                    // Update progress
                    updateSummary(totalTests, passed, failed, i + 1);
                }
                
                runButton.textContent = 'üöÄ Run Synchronized Tests';
                originalButton.textContent = 'üìã Run Original Tests';
                runButton.disabled = false;
                originalButton.disabled = false;
                
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <strong>Failed to run tests:</strong> ${error.message}
                    </div>
                `;
                runButton.textContent = 'üöÄ Run Synchronized Tests';
                originalButton.textContent = 'üìã Run Original Tests';
                runButton.disabled = false;
                originalButton.disabled = false;
            }
        }
        
        window.runAllTests = async function() {
            await runTestSuite(synchronizedTestSuite, 'Synchronized Tests');
        };
        
        window.runOriginalTests = async function() {
            await runTestSuite(originalTestSuite, 'Original Tests');
        };
        
        function createTestResultDiv(testName, index) {
            const div = document.createElement('div');
            div.className = 'test-result';
            div.id = `test-${index}`;
            div.innerHTML = `
                <div class="test-header">
                    <span class="collapsible" onclick="toggleTestContent(${index})">${testName}</span>
                    <span>
                        <span class="status">PENDING</span>
                        <span class="duration"></span>
                    </span>
                </div>
                <div class="test-content collapsible-content" id="content-${index}">
                    <div class="loading">Waiting to run...</div>
                </div>
            `;
            return div;
        }
        
        function formatTestResult(result, duration) {
            let html = `<div class="test-metadata">
                <strong>Duration:</strong> ${duration.toFixed(2)}ms<br>
            `;
            
            if (result.description) {
                html += `<strong>Description:</strong> ${result.description}<br>`;
            }
            
            if (result.style) {
                html += `<strong>Style:</strong> ${result.style}<br>`;
            }
            
            if (result.width !== undefined) {
                html += `<strong>Width:</strong> ${result.width} characters<br>`;
            }
            
            if (result.height !== undefined) {
                html += `<strong>Height:</strong> ${result.height} lines<br>`;
            }
            
            html += `</div>`;
            
            // Performance metrics
            if (result.creationTime !== undefined) {
                html += `<div class="test-metadata">
                    <strong>üìä Performance Metrics:</strong><br>
                    <strong>Creation Time:</strong> ${result.creationTime.toFixed(2)}ms<br>
                    <strong>Render Time:</strong> ${result.renderTime.toFixed(2)}ms<br>`;
                
                if (result.htmlConversionTime !== undefined) {
                    html += `<strong>HTML Conversion Time:</strong> ${result.htmlConversionTime.toFixed(2)}ms<br>`;
                }
                
                if (result.plainLength !== undefined) {
                    html += `<strong>Plain Length:</strong> ${result.plainLength} characters<br>`;
                }
                
                if (result.htmlLength !== undefined) {
                    html += `<strong>HTML Length:</strong> ${result.htmlLength} characters<br>`;
                }
                
                html += `</div>`;
            }
            
            if (result.maxLineLength !== undefined) {
                html += `<div class="test-metadata"><strong>Max Line Length:</strong> ${result.maxLineLength} characters</div>`;
            }
            
            // Main table output - show both plain and HTML rendered side by side
            if (result.output && result.htmlOutput) {
                html += `
                <div class="test-metadata"><strong>üìã Table Output:</strong></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">Plain Text (with ANSI codes):</h4>
                        <div class="test-output" style="font-size: 11px; max-height: 300px; overflow-y: auto;">${escapeHtml(result.output)}</div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">Rendered HTML (ANSI converted):</h4>
                        <div class="test-output" style="background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 11px;">${result.htmlOutput}</div>
                    </div>
                </div>`;
            } else if (result.output) {
                html += `<div class="test-metadata"><strong>üìã Table Output:</strong></div>
                <div class="test-output">${escapeHtml(result.output)}</div>`;
            }
            
            // Plain and HTML outputs for other test types
            if (result.plainOutput && result.htmlOutput) {
                html += `
                <div class="test-metadata"><strong>üé® Comparison:</strong></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">Plain Text:</h4>
                        <div class="test-output" style="font-size: 11px; max-height: 300px; overflow-y: auto;">${escapeHtml(result.plainOutput)}</div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">Rendered HTML:</h4>
                        <div class="test-output" style="background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; max-height: 300px; overflow-y: auto; font-size: 11px;">${result.htmlOutput}</div>
                    </div>
                </div>`;
            } else if (result.plainOutput) {
                html += `<div class="test-metadata"><strong>Plain Output:</strong></div>
                <div class="test-output">${escapeHtml(result.plainOutput)}</div>`;
            } else if (result.htmlOutput) {
                html += `<div class="test-metadata"><strong>HTML Output:</strong></div>
                <div class="test-output">${escapeHtml(result.htmlOutput)}</div>`;
            }
            
            // ANSI conversion specific outputs
            if (result.input && result.output && !result.htmlOutput) {
                html += `
                <div class="test-metadata"><strong>üîÑ ANSI Conversion:</strong></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 10px 0;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">ANSI Input:</h4>
                        <div class="test-output" style="font-size: 11px;">${escapeHtml(result.input)}</div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #666;">HTML Output:</h4>
                        <div class="test-output" style="background: #f8f9fa; border: 1px solid #e9ecef; padding: 10px; font-size: 11px;">${result.output}</div>
                    </div>
                </div>`;
            }
            
            // Preview for large outputs
            if (result.preview) {
                html += `<div class="test-metadata"><strong>üìù Preview:</strong></div>
                <div class="test-output">${escapeHtml(result.preview)}</div>`;
            }
            
            // Options output
            if (result.outputWithOptions) {
                html += `<div class="test-metadata"><strong>Output With Options:</strong></div>
                <div class="test-output">${escapeHtml(result.outputWithOptions)}</div>`;
            }
            
            return html;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function updateSummary(total, passed, failed, progress) {
            document.getElementById('total-tests').textContent = total;
            document.getElementById('passed-tests').textContent = passed;
            document.getElementById('failed-tests').textContent = failed;
            
            const successRate = total > 0 ? ((passed / (passed + failed)) * 100).toFixed(1) : 0;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            
            const progressPercent = total > 0 ? (progress / total) * 100 : 0;
            document.getElementById('progress').style.width = `${progressPercent}%`;
        }
        
        window.toggleTestContent = function(index) {
            const content = document.getElementById(`content-${index}`);
            const header = document.querySelector(`#test-${index} .collapsible`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                header.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                header.classList.add('collapsed');
            }
        };
        
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = `
                <div class="loading">
                    Click "Run All Tests" to start the comprehensive test suite.
                    <br><br>
                    This suite includes tests adapted from the original comfy-table library,
                    covering table creation, styling, edge cases, and performance tests.
                </div>
            `;
            updateSummary(0, 0, 0, 0);
            currentResults = [];
        };
        
        window.toggleAllOutputs = function() {
            const allContents = document.querySelectorAll('.collapsible-content');
            const allHeaders = document.querySelectorAll('.collapsible');
            
            const anyExpanded = Array.from(allContents).some(content => !content.classList.contains('collapsed'));
            
            allContents.forEach((content, index) => {
                if (anyExpanded) {
                    content.classList.add('collapsed');
                    allHeaders[index].classList.add('collapsed');
                } else {
                    content.classList.remove('collapsed');
                    allHeaders[index].classList.remove('collapsed');
                }
            });
        };
        
        // Debug functions
        window.toggleDebugMode = function() {
            debugMode = !debugMode;
            const button = document.getElementById('debug-mode');
            button.textContent = debugMode ? 'üîç Debug Mode: ON' : 'üîç Debug Mode: OFF';
            button.style.background = debugMode ? '#28a745' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        };
        
        window.debugFailedTest = function(testName) {
            // Create a debug popup or section
            const debugDiv = document.createElement('div');
            debugDiv.style.cssText = `
                position: fixed;
                top: 10%;
                left: 10%;
                width: 80%;
                height: 80%;
                background: white;
                border: 2px solid #007acc;
                border-radius: 8px;
                z-index: 1000;
                overflow: auto;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            debugDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üîç Debug: ${testName}</h2>
                    <button onclick="this.parentElement.parentElement.remove()" style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">Close</button>
                </div>
                <div id="debug-content">Loading debug information...</div>
            `;
            
            document.body.appendChild(debugDiv);
            
            // Run the specific test for debugging
            setTimeout(async () => {
                try {
                    await initializeWasm();
                    
                    if (testName.includes('Dynamic Content Arrangement')) {
                        const table = new TableWrapper();
                        table.set_header([
                            '\x1b[1m\x1b[34mHeader1\x1b[0m',
                            '\x1b[1m\x1b[35mHeader2\x1b[0m', 
                            '\x1b[1m\x1b[36mHead\x1b[0m'
                        ]);
                        table.set_width(25);
                        table.add_row([
                            '\x1b[32mThis is a very long line with a lot of text\x1b[0m',
                            '\x1b[33mThis is anotherverylongtextwithlongwords text\x1b[0m',
                            '\x1b[31msmol\x1b[0m'
                        ]);
                        
                        const result = table.to_string();
                        const htmlResult = table.to_html();
                        const lines = result.split('\n');
                        const maxLineLength = Math.max(...lines.map(line => line.length));
                        
                        const debugInfo = { 
                            output: result, 
                            htmlOutput: htmlResult,
                            maxLineLength: maxLineLength,
                            width: 25,
                            description: 'Debug output for Dynamic Content Arrangement test',
                            lines: lines,
                            lineCount: lines.length
                        };
                        
                        const debugContent = document.getElementById('debug-content');
                        debugContent.innerHTML = `
                            <div class="test-metadata">
                                <strong>Expected:</strong> maxLineLength should be ‚â§ 35 (25 + tolerance for borders)<br>
                                <strong>Actual:</strong> ${maxLineLength} characters<br>
                                <strong>Status:</strong> ${maxLineLength <= 35 ? '‚úÖ PASS' : '‚ùå FAIL'}<br>
                                <strong>Lines:</strong> ${lines.length}<br>
                                <strong>Width Setting:</strong> 25 characters<br>
                            </div>
                            
                            <div class="test-metadata"><strong>üìã Line Analysis:</strong></div>
                            <div class="test-output" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                                ${lines.map((line, i) => `Line ${i + 1} (${line.length} chars): ${escapeHtml(line)}`).join('\n')}
                            </div>
                            
                            ${formatTestResult(debugInfo, 0)}
                        `;
                    } else {
                        document.getElementById('debug-content').innerHTML = `
                            <div class="error-message">
                                Debug function for "${testName}" not yet implemented. 
                                <br>Please check the console for more details.
                            </div>
                        `;
                    }
                } catch (error) {
                    document.getElementById('debug-content').innerHTML = `
                        <div class="error-message">
                            <strong>Debug Error:</strong> ${error.message}
                        </div>
                    `;
                }
            }, 100);
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Comfy Table WASM Test Suite loaded');
        });
    </script>
</body>
</html>